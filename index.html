<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>CRASH</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
  body {
    background: #0a0a1a;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    height: 100vh;
    height: 100dvh;
    font-family: 'Press Start 2P', monospace;
    overflow: hidden;
    touch-action: none;
    padding-top: env(safe-area-inset-top, 4px);
  }
  #game-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    max-width: 420px;
    width: 95vw;
    position: relative;
    padding-top: 2px;
    height: 100%;
    overflow: hidden;
  }
  @media (pointer: coarse) {
    #game-wrap { padding-bottom: 140px; } /* space for fixed d-pad */
  }
  #title { font-size: 1.8rem; color: #e8451c; text-shadow: 3px 3px 0 #7a1a00, 0 0 20px #ff4500aa; letter-spacing: 6px; animation: titlePulse 1.5s ease-in-out infinite alternate; line-height: 1; }
  @keyframes titlePulse { from { text-shadow: 3px 3px 0 #7a1a00, 0 0 10px #ff4500aa; } to { text-shadow: 3px 3px 0 #7a1a00, 0 0 30px #ff6a33cc; } }
  #subtitle { font-size: 0.35rem; color: #7799aa; letter-spacing: 1px; }
  #dave-title { font-size: 0.3rem; color: #ffaa00; letter-spacing: 1px; min-height: 8px; }
  @media (pointer: coarse) {
    #title { font-size: 1.4rem; }
    #subtitle { font-size: 0.3rem; }
  }
  #timer-bar-outer { width: 100%; height: 14px; background: #1a1a2e; border: 2px solid #333355; border-radius: 2px; overflow: hidden; }
  #timer-bar { height: 100%; background: #22cc44; transition: width 0.1s linear, background 0.3s; width: 100%; }
  #timer-bar.danger { background: #ee2222; animation: barFlash 0.4s ease-in-out infinite alternate; }
  @keyframes barFlash { from { opacity: 1; } to { opacity: 0.4; } }
  #timer-text { font-size: 0.45rem; color: #99aabb; align-self: flex-end; margin-top: -2px; }
  /* NPC timer bar */
  #npc-timer-wrap { width: 100%; display: none; }
  #npc-timer-wrap.active { display: block; }
  #npc-timer-label { font-size: 0.28rem; color: #ff77aa; margin-bottom: 1px; }
  #npc-timer-outer { width: 100%; height: 8px; background: #1a1a2e; border: 2px solid #553355; border-radius: 2px; overflow: hidden; }
  #npc-timer-bar { height: 100%; background: #ff77aa; transition: width 0.1s linear; width: 100%; }
  #npc-timer-bar.danger { background: #ff2255; animation: barFlash 0.3s ease-in-out infinite alternate; }
  #game-board {
    display: grid; gap: 2px; padding: 4px;
    background: #111128; border: 2px solid #222244; border-radius: 4px;
    width: 100%; aspect-ratio: 1;
    flex-shrink: 1; min-height: 0;
  }
  @media (pointer: coarse) {
    #game-board { max-height: 50vh; max-width: 50vh; }
  }
  .cell {
    background: #1e2040; border-radius: 2px;
    display: flex; align-items: center; justify-content: center;
    position: relative; transition: background 0.15s; aspect-ratio: 1; overflow: visible;
  }
  .cell.alt { background: #232548; }
  .cell.blackout { background: #000000 !important; box-shadow: inset 0 0 10px #000; }
  .cell.blackout .cell-content { visibility: hidden; }
  .cell.player-here { background: #1a3355 !important; }
  .cell.wrong-flash { animation: wrongShake 0.3s; background: #661111 !important; }
  .cell.desk-cell { background: #2a2520 !important; border: 1px solid #554433; }
  .cell.npc-cell { background: #2a1a2a !important; }
  /* Pulsing beacon rings */
  .beacon { position: relative; }
  .beacon::after {
    content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px;
    border-radius: 4px; border: 2px solid var(--beacon-color, #44cc44);
    animation: beaconPulse 1s ease-out infinite; pointer-events: none; z-index: 2;
  }
  @keyframes beaconPulse {
    0% { transform: scale(0.85); opacity: 1; }
    100% { transform: scale(1.2); opacity: 0; }
  }
  .beacon-green { --beacon-color: #44ee44; }
  .beacon-blue { --beacon-color: #4488ff; }
  .beacon-pink { --beacon-color: #ff66aa; }
  .beacon-orange { --beacon-color: #ffaa44; }
  /* Step indicator badge */
  .step-badge {
    position: absolute; top: -4px; left: -4px;
    width: 16px; height: 16px; border-radius: 50%;
    background: #ff4466; color: white; font-size: 0.35rem;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Press Start 2P', monospace;
    z-index: 3; border: 1px solid #cc2244;
    animation: badgeBounce 0.6s ease-in-out infinite alternate;
  }
  @keyframes badgeBounce { from { transform: scale(1); } to { transform: scale(1.15); } }
  @keyframes wrongShake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
  .cell-content {
    display: flex; align-items: center; justify-content: center;
    width: 100%; height: 100%; font-size: clamp(0.7rem, 3.5vw, 1.4rem);
  }
  .player { width: 70%; height: 80%; position: relative; }
  .player-body { width: 100%; height: 65%; background: #33aaee; border-radius: 3px 3px 1px 1px; position: absolute; bottom: 0; border: 2px solid #2288bb; }
  .player-head { width: 70%; height: 50%; background: #33aaee; border-radius: 3px; position: absolute; top: 0; left: 15%; border: 2px solid #2288bb; }
  .player-eyes { position: absolute; top: 30%; left: 50%; transform: translateX(-50%); display: flex; gap: 2px; }
  .player-eye { width: 3px; height: 4px; background: white; border-radius: 1px; }
  .player-hat { position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 80%; height: 5px; border-radius: 2px 2px 0 0; display: none; }
  /* Carrying indicator */
  .carrying-indicator { position: absolute; top: -2px; right: -2px; font-size: 0.5rem; animation: carryBob 0.6s ease-in-out infinite alternate; }
  @keyframes carryBob { from { transform: translateY(0); } to { transform: translateY(-3px); } }
  #order-bar {
    display: flex; gap: 3px; padding: 4px 6px;
    background: #111128; border: 2px solid #222244; border-radius: 4px;
    width: 100%; justify-content: center; flex-wrap: wrap; min-height: 36px; align-items: center;
    flex-shrink: 0;
  }
  .order-item {
    width: 30px; height: 30px; background: #1e2040; border: 2px solid #333355; border-radius: 4px;
    display: flex; align-items: center; justify-content: center; font-size: 0.85rem;
    position: relative; transition: all 0.2s;
  }
  .order-item.collected { border-color: #22cc44; background: #112211; opacity: 0.5; }
  .order-item.next { border-color: #ffaa00; box-shadow: 0 0 8px #ffaa0066; animation: nextPulse 0.8s ease-in-out infinite alternate; }
  @keyframes nextPulse { from { box-shadow: 0 0 5px #ffaa0044; } to { box-shadow: 0 0 14px #ffaa0088; } }
  .order-num { position: absolute; top: -5px; right: -5px; background: #e8451c; color: white; font-size: 0.35rem; width: 12px; height: 12px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  #info-row { display: flex; justify-content: space-between; width: 100%; font-size: 0.4rem; color: #7799aa; }
  #score-display, #level-display, #highscore-display { padding: 3px 6px; background: #111128; border: 1px solid #222244; border-radius: 3px; }
  #highscore-display { color: #ffaa00; }

  /* ‚ïê‚ïê‚ïê SPLIT D-PAD CONTROLS ‚ïê‚ïê‚ïê */
  #dpad-area {
    width: 100%; max-width: 420px; display: flex; justify-content: space-between; align-items: center;
    padding: 8px 16px; gap: 20px;
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    background: linear-gradient(to top, #0a0a1a 60%, transparent);
    padding-bottom: max(10px, env(safe-area-inset-bottom, 10px));
    z-index: 80;
  }
  .dpad-group {
    display: flex; align-items: center; gap: 6px;
  }
  .dpad-group.vertical { flex-direction: column; }
  .dpad-btn {
    width: 56px; height: 56px; border-radius: 6px;
    background: #151530; border: 3px solid #333366;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Press Start 2P', monospace; font-size: 1.1rem; color: #5566aa;
    cursor: pointer; position: relative;
    box-shadow: inset 0 -3px 0 #0a0a1a, 0 3px 6px rgba(0,0,0,0.4);
    transition: all 0.06s;
  }
  .dpad-btn:active, .dpad-btn.pressed {
    background: #1a1a44; border-color: #7788ee; color: #99aaff;
    box-shadow: inset 0 2px 0 #0a0a1a, 0 1px 3px rgba(0,0,0,0.3);
    transform: translateY(2px);
  }
  .dpad-label {
    font-size: 0.3rem; color: #334466; text-align: center;
    font-family: 'Press Start 2P', monospace; letter-spacing: 1px;
  }
  /* Graffiti tag ‚Äî 80's bubble pixel art */
  .graffiti {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    font-family: 'Press Start 2P', monospace;
    font-size: 1.6rem; color: #ff44cc; letter-spacing: 4px;
    transform: rotate(-2deg);
    text-shadow:
      3px 3px 0 #aa0066,
      6px 6px 0 #660044,
      -1px -1px 0 #ff88ee,
      0 0 10px #ff44cc88,
      0 0 30px #ff00aa44,
      0 0 50px #cc006622;
    white-space: nowrap;
    font-weight: bold;
    text-align: center;
    padding: 6px 0 max(6px, env(safe-area-inset-bottom, 6px));
    background: linear-gradient(to top, #0a0a1a 40%, transparent);
    -webkit-text-stroke: 1px #aa0066;
    animation: graffitiGlow 2s ease-in-out infinite alternate;
    z-index: 70;
    pointer-events: none;
  }
  @media (pointer: coarse) {
    .graffiti { bottom: 120px; background: none; }
  }
  @keyframes graffitiGlow {
    from { text-shadow: 3px 3px 0 #aa0066, 6px 6px 0 #660044, -1px -1px 0 #ff88ee, 0 0 10px #ff44cc88, 0 0 30px #ff00aa44; }
    to { text-shadow: 3px 3px 0 #aa0066, 6px 6px 0 #660044, -1px -1px 0 #ff88ee, 0 0 20px #44eeffaa, 0 0 40px #00ccff66, 0 0 60px #ff44cc44; }
  }
  /* Hide d-pad on desktop, show on touch */
  #dpad-area { display: none; }
  @media (pointer: coarse) { #dpad-area { display: flex; } }
  @media (hover: none) { #dpad-area { display: flex; } }

  /* ‚ïê‚ïê‚ïê OVERLAYS ‚ïê‚ïê‚ïê */
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.88); display: flex; flex-direction: column;
    align-items: center; justify-content: center; z-index: 100; gap: 12px;
  }
  .overlay.hidden { display: none; }
  .overlay h2 { font-family: 'Press Start 2P', monospace; font-size: 1.2rem; color: #e8451c; text-shadow: 2px 2px 0 #7a1a00; text-align: center; line-height: 1.6; }
  .overlay p { font-family: 'Press Start 2P', monospace; font-size: 0.42rem; color: #7799aa; text-align: center; line-height: 2; max-width: 320px; }
  .overlay .score-final { font-size: 0.6rem; color: #ffaa00; }
  .btn { font-family: 'Press Start 2P', monospace; font-size: 0.55rem; padding: 10px 20px; background: #e8451c; color: white; border: none; border-radius: 3px; cursor: pointer; margin-top: 6px; text-shadow: 1px 1px 0 #7a1a00; }
  .btn:hover { background: #ff5a2e; }
  .btn:active { transform: scale(0.95); }

  /* Ticket interrupt overlay */
  #ticket-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.75); display: none; flex-direction: column;
    align-items: center; justify-content: center; z-index: 90; gap: 10px;
    animation: ticketSlam 0.3s;
  }
  #ticket-overlay.active { display: flex; }
  @keyframes ticketSlam { 0% { transform: scale(1.3); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
  #ticket-name { font-family: 'Press Start 2P', monospace; font-size: 0.7rem; color: #ff6688; text-shadow: 0 0 10px #ff668866; }
  #ticket-dept { font-family: 'Press Start 2P', monospace; font-size: 0.4rem; color: #aabbcc; margin-top: -4px; }
  #ticket-msg { font-family: 'Press Start 2P', monospace; font-size: 0.45rem; color: #ffaa44; text-align: center; line-height: 2; max-width: 300px; }
  #ticket-icon { font-size: 2.5rem; animation: ticketBounce 0.4s ease-in-out 3 alternate; }
  @keyframes ticketBounce { from { transform: translateY(0) rotate(-5deg); } to { transform: translateY(-10px) rotate(5deg); } }

  .shake { animation: screenShake 0.3s; }
  @keyframes screenShake { 0%,100% { transform: translate(0); } 10% { transform: translate(-3px, 2px); } 30% { transform: translate(3px, -2px); } 50% { transform: translate(-2px, 3px); } 70% { transform: translate(2px, -3px); } 90% { transform: translate(-1px, 1px); } }
  .server-saved { animation: savedFlash 0.6s ease-out 3; }
  @keyframes savedFlash { 0% { box-shadow: 0 0 0 #22cc44; } 50% { box-shadow: 0 0 40px #22cc4466; } 100% { box-shadow: 0 0 0 #22cc44; } }
  .penalty-popup { position: fixed; font-family: 'Press Start 2P', monospace; font-size: 0.6rem; color: #ee2222; pointer-events: none; z-index: 50; animation: penaltyFade 1s forwards; }
  @keyframes penaltyFade { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }
  #promo-screen h2 { color: #ffaa00; text-shadow: 2px 2px 0 #886600; }
  .promo-title { font-size: 0.8rem !important; color: #ffdd44 !important; text-shadow: 0 0 10px #ffaa0066; }
  .promo-desc { font-size: 0.38rem !important; color: #aabbcc !important; font-style: italic; }
  .new-highscore { font-size: 0.55rem; color: #ffdd44; animation: hsFlash 0.5s ease-in-out infinite alternate; }
  @keyframes hsFlash { from { text-shadow: 0 0 5px #ffdd4444; } to { text-shadow: 0 0 15px #ffdd44aa; } }
  #sound-toggle { position: fixed; top: 8px; right: 8px; font-size: 1rem; background: #111128; border: 2px solid #333355; border-radius: 4px; padding: 4px 6px; cursor: pointer; z-index: 200; color: white; }
  /* NPC waiting indicator */
  .npc-waiting { animation: npcPulse 0.8s ease-in-out infinite alternate; }
  @keyframes npcPulse { from { opacity: 0.7; } to { opacity: 1; } }
  /* Side quest status bar */
  #sidequest-bar { width: 100%; display: none; padding: 5px 8px; background: #1a1128; border: 2px solid #663388; border-radius: 4px; font-size: 0.35rem; color: #ddaaff; text-align: center; line-height: 1.6; flex-shrink: 0; }
  #sidequest-bar.active { display: block; animation: sqPulse 2s ease-in-out infinite alternate; }
  @keyframes sqPulse { from { border-color: #663388; } to { border-color: #9944cc; box-shadow: 0 0 8px #9944cc44; } }
</style>
</head>
<body>

<button id="sound-toggle" title="Toggle Sound">üîä</button>

<!-- START SCREEN -->
<div class="overlay" id="start-screen">
  <h2>CRASH</h2>
  <p>Dave from IT is in crisis!<br><br>
  The servers are melting down!<br><br>
  Collect repair items in the<br>correct order to fix each server!<br><br>
  Watch out for blackouts,<br>ticket interruptions, and<br>needy coworkers!</p>
  <p style="color:#ffaa00; margin-top:6px;">ARROW KEYS or JOYSTICK</p>
  <button class="btn" id="start-btn">START</button>
</div>

<!-- GAME OVER -->
<div class="overlay hidden" id="gameover-screen">
  <h2>SERVER CRASHED!</h2>
  <p>Dave couldn't save the servers...</p>
  <p class="score-final" id="final-score"></p>
  <p class="score-final" id="final-level"></p>
  <p class="new-highscore hidden" id="new-hs">‚òÖ NEW HIGH SCORE ‚òÖ</p>
  <button class="btn" id="restart-btn">TRY AGAIN</button>
</div>

<!-- LEVEL COMPLETE -->
<div class="overlay hidden" id="level-screen">
  <h2 style="color:#22cc44">SERVER SAVED!</h2>
  <p id="level-msg"></p>
  <p class="score-final" id="level-score"></p>
  <button class="btn" id="next-btn" style="background:#22aa44">NEXT SERVER</button>
</div>

<!-- PROMOTION -->
<div class="overlay hidden" id="promo-screen">
  <h2>‚¨Ü PROMOTION! ‚¨Ü</h2>
  <p style="color:#ffaa00;">Dave got promoted!</p>
  <p class="promo-title" id="promo-new-title"></p>
  <p class="promo-desc" id="promo-desc"></p>
  <button class="btn" id="promo-btn" style="background:#cc8800;">NICE!</button>
</div>

<!-- TICKET INTERRUPT -->
<div id="ticket-overlay">
  <div id="ticket-icon">üìã</div>
  <div id="ticket-name"></div>
  <div id="ticket-dept"></div>
  <div id="ticket-msg"></div>
  <div id="ticket-tap" style="font-family:'Press Start 2P',monospace;font-size:0.3rem;color:#556677;margin-top:8px;animation:nextPulse 0.8s ease-in-out infinite alternate;">[TAP TO DISMISS]</div>
  <div id="ticket-reply" style="font-family:'Press Start 2P',monospace;font-size:0.5rem;color:#44ee88;text-align:center;margin-top:10px;display:none;text-shadow:0 0 8px #44ee8866;line-height:2;"></div>
</div>

<!-- GAME -->
<div id="game-wrap">
  <div id="title">CRASH</div>
  <div id="subtitle">DAVE FROM IT vs THE MELTDOWN</div>
  <div id="dave-title"></div>
  <div id="info-row">
    <div id="level-display">LVL 1</div>
    <div id="highscore-display">HI 0</div>
    <div id="score-display">0</div>
  </div>
  <div id="timer-bar-outer"><div id="timer-bar"></div></div>
  <div id="npc-timer-wrap">
    <div id="npc-timer-label"></div>
    <div id="npc-timer-outer"><div id="npc-timer-bar"></div></div>
  </div>
  <div id="timer-text"></div>
  <div id="sidequest-bar"></div>
  <div id="game-board"></div>
  <div id="order-bar"></div>


</div>

<!-- SPLIT D-PAD CONTROLS (fixed to bottom of viewport) -->
<div id="dpad-area">
  <div style="display:flex;flex-direction:column;align-items:center;gap:3px;">
    <div class="dpad-label">MOVE</div>
    <div class="dpad-group">
      <div class="dpad-btn" data-dir="left" id="btn-left">‚óÑ</div>
      <div class="dpad-btn" data-dir="right" id="btn-right">‚ñ∫</div>
    </div>
  </div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:3px;">
    <div class="dpad-label">MOVE</div>
    <div class="dpad-group vertical">
      <div class="dpad-btn" data-dir="up" id="btn-up">‚ñ≤</div>
      <div class="dpad-btn" data-dir="down" id="btn-down">‚ñº</div>
    </div>
  </div>
</div>
<div class="graffiti">Nico was ere</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SOUND ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let audioCtx = null, soundEnabled = true, tickInterval = null;
function initAudio() { if (audioCtx) return; audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function playTone(freq, dur, type='square', vol=0.12) {
  if (!audioCtx || !soundEnabled) return;
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq; g.gain.value = vol;
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
  o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + dur);
}
function sfxMove() { playTone(220, 0.06, 'square', 0.07); }
function sfxCollect() { playTone(523,0.08,'square',0.13); setTimeout(()=>playTone(659,0.08,'square',0.13),60); setTimeout(()=>playTone(784,0.12,'square',0.15),120); setTimeout(()=>playTone(1047,0.18,'square',0.12),190); }
function sfxWrongDonk() {
  if (!audioCtx || !soundEnabled) return;
  const t = audioCtx.currentTime;
  const o1=audioCtx.createOscillator(),g1=audioCtx.createGain();
  o1.type='sine'; o1.frequency.setValueAtTime(150,t); o1.frequency.exponentialRampToValueAtTime(80,t+0.15);
  g1.gain.setValueAtTime(0.35,t); g1.gain.exponentialRampToValueAtTime(0.001,t+0.2);
  o1.connect(g1); g1.connect(audioCtx.destination); o1.start(t); o1.stop(t+0.2);
  const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();
  o2.type='triangle'; o2.frequency.setValueAtTime(280,t+0.02); o2.frequency.exponentialRampToValueAtTime(120,t+0.18);
  g2.gain.setValueAtTime(0.3,t+0.02); g2.gain.exponentialRampToValueAtTime(0.001,t+0.22);
  o2.connect(g2); g2.connect(audioCtx.destination); o2.start(t+0.02); o2.stop(t+0.22);
  const bs=audioCtx.sampleRate*0.08, buf=audioCtx.createBuffer(1,bs,audioCtx.sampleRate), d=buf.getChannelData(0);
  for(let i=0;i<bs;i++) d[i]=(Math.random()*2-1)*0.15;
  const n=audioCtx.createBufferSource(),ng=audioCtx.createGain(); n.buffer=buf;
  ng.gain.setValueAtTime(0.15,t); ng.gain.exponentialRampToValueAtTime(0.001,t+0.08);
  n.connect(ng); ng.connect(audioCtx.destination); n.start(t); n.stop(t+0.08);
}
function sfxBlackout() { playTone(60,0.3,'sine',0.1); playTone(55,0.3,'triangle',0.06); }
function sfxLightOn() { playTone(880,0.05,'square',0.08); setTimeout(()=>playTone(1100,0.08,'square',0.06),40); }
function sfxLevelComplete() { [523,659,784,1047,784,1047,1319].forEach((n,i)=>setTimeout(()=>playTone(n,0.15,'square',0.12),i*100)); }
function sfxPromotion() { [392,523,659,784,0,784,1047,1319,1568].forEach((n,i)=>{if(n>0)setTimeout(()=>playTone(n,0.18,'square',0.13),i*120)}); }
function sfxGameOver() { [523,466,392,330,262,196,131].forEach((n,i)=>setTimeout(()=>{playTone(n,0.25,'square',0.1);playTone(n*0.5,0.25,'triangle',0.06)},i*150)); }
function sfxTicket() { playTone(440,0.1,'square',0.15); setTimeout(()=>playTone(550,0.1,'square',0.15),100); setTimeout(()=>playTone(440,0.15,'square',0.15),200); }
function sfxNpcArrive() { playTone(330,0.1,'triangle',0.1); setTimeout(()=>playTone(440,0.12,'triangle',0.1),120); }
function sfxNpcComplete() { [440,554,659,880].forEach((n,i)=>setTimeout(()=>playTone(n,0.12,'square',0.1),i*80)); }
function sfxNpcFail() { playTone(200,0.3,'sawtooth',0.08); }

// Phone ringing ‚Äî classic retro ring-ring
let phoneRingInterval=null;
function sfxPhoneRing(){
  if(!audioCtx||!soundEnabled) return;
  if(phoneRingInterval) clearInterval(phoneRingInterval);
  let rings=0;
  phoneRingInterval=setInterval(()=>{
    if(!soundEnabled||!state.phone||rings>=20){clearInterval(phoneRingInterval);phoneRingInterval=null;return;}
    playTone(1200,0.06,'square',0.1);
    setTimeout(()=>playTone(1400,0.06,'square',0.1),70);
    setTimeout(()=>playTone(1200,0.06,'square',0.1),140);
    rings++;
  },500);
}
function stopPhoneRing(){if(phoneRingInterval){clearInterval(phoneRingInterval);phoneRingInterval=null;}}
function sfxPhoneAnswer(){playTone(600,0.08,'sine',0.1);setTimeout(()=>playTone(800,0.1,'sine',0.1),80);setTimeout(()=>playTone(1000,0.12,'sine',0.08),160);}
function sfxPhoneMissed(){playTone(300,0.15,'triangle',0.08);setTimeout(()=>playTone(200,0.2,'triangle',0.06),150);}

// Email ‚Äî "you've got mail" chime
function sfxEmailArrive(){
  playTone(523,0.12,'sine',0.1);
  setTimeout(()=>playTone(659,0.12,'sine',0.1),120);
  setTimeout(()=>playTone(784,0.15,'sine',0.12),240);
  setTimeout(()=>playTone(1047,0.2,'sine',0.1),380);
}
function sfxEmailRead(){playTone(880,0.06,'square',0.08);setTimeout(()=>playTone(1100,0.08,'square',0.06),60);}
function sfxEmailMissed(){playTone(250,0.12,'triangle',0.06);setTimeout(()=>playTone(180,0.15,'triangle',0.05),120);}

// Background music
const BASS_PATTERNS=[[65,0,82,0,98,0,82,0],[73,0,98,0,110,0,98,0],[87,0,110,0,131,0,110,0],[82,0,98,0,110,0,131,0]];
const MELODY_NOTES=[262,294,330,349,392,440,494,523,587,659];
let musicStep=0, musicInterval=null, currentBassPattern=0;
function startMusic() {
  if(musicInterval) clearInterval(musicInterval); musicStep=0; currentBassPattern=0;
  musicInterval=setInterval(()=>{
    if(!soundEnabled||!audioCtx||!state.running) return;
    const p=BASS_PATTERNS[currentBassPattern%BASS_PATTERNS.length], bn=p[musicStep%p.length];
    if(bn>0) playTone(bn,0.1,'triangle',0.035);
    if(musicStep%2===0&&Math.random()>0.4) playTone(MELODY_NOTES[Math.floor(Math.random()*MELODY_NOTES.length)],0.08,'square',0.02);
    if(audioCtx&&soundEnabled){const bs=audioCtx.sampleRate*0.015,buf=audioCtx.createBuffer(1,bs,audioCtx.sampleRate),dd=buf.getChannelData(0);for(let i=0;i<bs;i++)dd[i]=(Math.random()*2-1);const s=audioCtx.createBufferSource(),g=audioCtx.createGain();s.buffer=buf;g.gain.value=0.012;s.connect(g);g.connect(audioCtx.destination);s.start();s.stop(audioCtx.currentTime+0.015);}
    musicStep++; if(musicStep%16===0) currentBassPattern++;
  }, (60000/140)/2);
}
function stopMusic() { if(musicInterval){clearInterval(musicInterval);musicInterval=null;} }
function startCountdownTick() {
  if(tickInterval) clearInterval(tickInterval);
  tickInterval=setInterval(()=>{
    if(!state.running||!soundEnabled||!audioCtx) return;
    const pct=state.timeLeft/(state.maxTime*10);
    if(pct<0.6) playTone(800+(1-pct)*600,0.03,'square',Math.min(0.02+(1-pct)*0.04,0.06));
  },250);
}
function stopCountdownTick() { if(tickInterval){clearInterval(tickInterval);tickInterval=null;} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROMOTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROMOTIONS=[
  {title:'Intern',desc:'"Where\'s the any key?"',color:'#888888',level:0},
  {title:'Help Desk Grunt',desc:'"Have you tried turning it off and on again?"',color:'#44aa44',level:3},
  {title:'Cable Monkey',desc:'"I see the problem ‚Äî Layer 8 issue."',color:'#44aacc',level:6},
  {title:'Server Whisperer',desc:'"The server spoke to me... it said SEGFAULT."',color:'#6666dd',level:9},
  {title:'Firewall Wizard',desc:'"You shall not pass ‚Äî port 443."',color:'#aa44cc',level:12},
  {title:'Cloud Overlord',desc:'"It\'s not a bug, it\'s undocumented."',color:'#cc8800',level:15},
  {title:'CTO of Chaos',desc:'"I don\'t fix problems, I make them strategic."',color:'#ee4444',level:18},
  {title:'Digital God',desc:'"sudo rm -rf /fear"',color:'#ffdd44',level:21},
];
function getCurrentPromotion(){let p=PROMOTIONS[0];for(const x of PROMOTIONS)if(state.level>=x.level)p=x;return p;}
function checkPromotion(){const p=getCurrentPromotion();const i=PROMOTIONS.indexOf(p);return(i>0&&state.level===p.level)?p:null;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TICKET INTERRUPT PEOPLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TICKET_PEOPLE = [
  { name: 'Karen', dept: 'Marketing', msgs: ['"How does email work again?"','"I lost my computer. Like, the whole thing."','"The internet deleted itself."','"My mouse is upside down."','"Can you make the logo bigger in the database?"'] },
  { name: 'Chad', dept: 'Sales', msgs: ['"I spilled coffee on the server. Which button is undo?"','"My spreadsheet is haunted, rows keep appearing."','"I saved a file but now my desk drawer won\'t open?"','"I typed Google into Google and it broke."','"Can you install Tinder on my work laptop?"'] },
  { name: 'Greg', dept: 'Legal', msgs: ['"I need you to print the entire internet."','"Someone hacked my password. It was password123."','"My screen is too bright, I think it has a virus."','"I unplugged something and now the lights are off."','"The PDF is angry at me."'] },
  { name: 'Susan', dept: 'Management', msgs: ['"Where is the ANY key?"','"I deleted the recycle bin, can you recycle it back?"','"My laptop won\'t turn on. No I haven\'t plugged it in, why?"','"The WiFi tastes funny today."','"Can you make Excel more exciting?"'] },
  { name: 'Kevin', dept: 'Engineering', msgs: ['"I pushed to prod and now the building is on fire."','"The database is upside down."','"I accidentally mass-emailed my cat photos to all clients."','"Who put a firewall in front of my fire?"','"I rm -rf\'d something important. What was the company called again?"'] },
];
const TICKET_ICONS = ['üìã','üìù','üö®','üìå','‚ö†Ô∏è'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDE QUEST NPC SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NPC_REQUESTS = [
  { emoji:'ü™ë', name:'Broken Chair', person:'Janet from HR', personEmoji:'üë©‚Äçüíº' },
  { emoji:'üñ®Ô∏è', name:'Printer Jam', person:'Bob from Accounting', personEmoji:'üë®‚Äçüíº' },
  { emoji:'üíª', name:'New Laptop', person:'Tina the Temp', personEmoji:'üë©' },
  { emoji:'üîê', name:'Password Reset', person:'Frank from Facilities', personEmoji:'üë∑' },
  { emoji:'üì±', name:'Phone Setup', person:'New Hire Alex', personEmoji:'üßë' },
  { emoji:'üñ•Ô∏è', name:'Software Access', person:'Diane from Design', personEmoji:'üë©‚Äçüé®' },
  { emoji:'ü™™', name:'Badge Doesn\'t Work', person:'Security Mike', personEmoji:'üëÆ' },
  { emoji:'üìß', name:'Email Won\'t Send', person:'Patty from PR', personEmoji:'üíÅ‚Äç‚ôÄÔ∏è' },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME ITEMS & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ITEMS=[
  {emoji:'üîß',name:'Wrench'},{emoji:'üß≤',name:'Magnet'},{emoji:'üîë',name:'Key'},{emoji:'üîí',name:'Lock'},
  {emoji:'üíæ',name:'Disk'},{emoji:'üîå',name:'Plug'},{emoji:'ü™õ',name:'Screwdriver'},{emoji:'üì°',name:'Antenna'},
  {emoji:'üîã',name:'Battery'},{emoji:'üíø',name:'CD'},
];

let highScore = 0;
let state = {
  gridSize:5, level:1, score:0,
  player:{x:2,y:2}, items:[], order:[], nextCollect:0,
  blackouts:new Set(), timeLeft:0, maxTime:0, running:false,
  timerInterval:null, blackoutInterval:null, ticketInterval:null,
  // Side quest
  npc: null, npcTimerInterval: null, carrying: null,
  // Phone & Email interrupts
  phone: null, // { x, y, timer, maxTimer }
  phoneTimerInterval: null,
  email: null, // { x, y, timer, maxTimer }
  emailTimerInterval: null,
};

// DOM
const board=document.getElementById('game-board'), orderBar=document.getElementById('order-bar');
const timerBar=document.getElementById('timer-bar'), timerText=document.getElementById('timer-text');
const scoreDisplay=document.getElementById('score-display'), levelDisplay=document.getElementById('level-display');
const highscoreDisplay=document.getElementById('highscore-display'), gameWrap=document.getElementById('game-wrap');
const npcTimerWrap=document.getElementById('npc-timer-wrap'), npcTimerBar=document.getElementById('npc-timer-bar');
const npcTimerLabel=document.getElementById('npc-timer-label'), sidequestBar=document.getElementById('sidequest-bar');

function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}
function cellKey(x,y){return `${x},${y}`;}
function getEmptyCells(){
  const used=new Set();
  used.add(cellKey(state.player.x,state.player.y));
  state.items.forEach(it=>{if(!it.collected)used.add(cellKey(it.x,it.y));});
  if(state.npc){
    used.add(cellKey(state.npc.x,state.npc.y));
    used.add(cellKey(state.npc.deskX,state.npc.deskY));
    if(state.npc.phase==='waiting') used.add(cellKey(state.npc.itemX,state.npc.itemY));
  }
  if(state.phone) used.add(cellKey(state.phone.x,state.phone.y));
  if(state.email) used.add(cellKey(state.email.x,state.email.y));
  const empty=[];
  for(let y=0;y<state.gridSize;y++)for(let x=0;x<state.gridSize;x++)if(!used.has(cellKey(x,y)))empty.push({x,y});
  return shuffle(empty);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT LEVEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initLevel(){
  const gs=Math.min(5+Math.floor((state.level-1)/2),8);
  state.gridSize=gs;
  const numItems=Math.min(3+state.level,ITEMS.length);
  const baseTime=25+state.level*5;
  state.maxTime=baseTime; state.timeLeft=baseTime*10;
  state.nextCollect=0; state.blackouts=new Set();
  state.npc=null; state.carrying=null;
  state.phone=null; state.email=null;
  clearNpcTimer(); clearPhoneTimer(); clearEmailTimer();
  stopPhoneRing();
  npcTimerWrap.classList.remove('active');
  sidequestBar.classList.remove('active');

  state.player={x:Math.floor(gs/2),y:Math.floor(gs/2)};
  const picked=shuffle([...Array(ITEMS.length).keys()]).slice(0,numItems);
  state.items=[];
  const used=new Set(); used.add(cellKey(state.player.x,state.player.y));
  picked.forEach(idx=>{
    let pos; do{pos={x:Math.floor(Math.random()*gs),y:Math.floor(Math.random()*gs)};}while(used.has(cellKey(pos.x,pos.y)));
    used.add(cellKey(pos.x,pos.y));
    state.items.push({x:pos.x,y:pos.y,itemIdx:idx,collected:false});
  });
  state.order=shuffle([...Array(numItems).keys()]);
  board.style.gridTemplateColumns=`repeat(${gs},1fr)`;
  updateDaveTitle(); render(); renderOrder(); updateHUD();
}

function updateDaveTitle(){
  const p=getCurrentPromotion(),el=document.getElementById('dave-title');
  el.textContent=`Dave the ${p.title}`; el.style.color=p.color;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  board.innerHTML='';
  const promo=getCurrentPromotion(), promoIdx=PROMOTIONS.indexOf(promo);
  for(let y=0;y<state.gridSize;y++){
    for(let x=0;x<state.gridSize;x++){
      const cell=document.createElement('div');
      cell.className='cell';
      if((x+y)%2===1) cell.classList.add('alt');
      const key=cellKey(x,y);
      if(state.blackouts.has(key)) cell.classList.add('blackout');

      // Desk
      if(state.npc && state.npc.deskX===x && state.npc.deskY===y) cell.classList.add('desk-cell');
      // NPC
      if(state.npc && state.npc.x===x && state.npc.y===y) cell.classList.add('npc-cell');

      const content=document.createElement('div');
      content.className='cell-content';

      // Player
      if(state.player.x===x && state.player.y===y){
        cell.classList.add('player-here');
        const hatStyle=promoIdx>0?`display:block;background:${promo.color};`:'display:none;';
        const carryHtml=state.carrying?`<div class="carrying-indicator">${state.carrying}</div>`:'';
        content.innerHTML=`<div class="player" style="position:relative">
          <div class="player-hat" style="${hatStyle}"></div>
          <div class="player-head"><div class="player-eyes"><div class="player-eye"></div><div class="player-eye"></div></div></div>
          <div class="player-body"></div>${carryHtml}</div>`;
      }
      // NPC person
      else if(state.npc && state.npc.x===x && state.npc.y===y){
        content.innerHTML=`<span class="npc-waiting">${state.npc.request.personEmoji}</span>`;
        cell.classList.add('beacon','beacon-pink');
        // Step badge: show step number based on phase
        if(state.npc.phase==='delivered'){
          const badge=document.createElement('div');badge.className='step-badge';badge.textContent='3';cell.appendChild(badge);
        }
      }
      // Desk
      else if(state.npc && state.npc.deskX===x && state.npc.deskY===y){
        content.textContent='üóÑÔ∏è';
        if(state.npc.phase==='gotItem'){
          cell.classList.add('beacon','beacon-orange');
          const badge=document.createElement('div');badge.className='step-badge';badge.textContent='2';cell.appendChild(badge);
        }
      }
      // NPC item (only if phase=waiting)
      else if(state.npc && state.npc.phase==='waiting' && state.npc.itemX===x && state.npc.itemY===y){
        content.textContent=state.npc.request.emoji;
        cell.classList.add('beacon','beacon-pink');
        const badge=document.createElement('div');badge.className='step-badge';badge.textContent='1';cell.appendChild(badge);
      }
      // Phone
      else if(state.phone && state.phone.x===x && state.phone.y===y){
        content.innerHTML='<span class="npc-waiting" style="font-size:clamp(1rem,5vw,1.8rem)">üìû</span>';
        cell.classList.add('beacon','beacon-green');
      }
      // Email
      else if(state.email && state.email.x===x && state.email.y===y){
        content.innerHTML='<span class="npc-waiting" style="font-size:clamp(1rem,5vw,1.8rem)">üìß</span>';
        cell.classList.add('beacon','beacon-blue');
      }
      // Regular item
      else {
        const item=state.items.find(it=>it.x===x&&it.y===y&&!it.collected);
        if(item) content.textContent=ITEMS[item.itemIdx].emoji;
      }

      cell.appendChild(content);
      board.appendChild(cell);
    }
  }
}

function renderOrder(){
  orderBar.innerHTML='';
  state.order.forEach((idx,seq)=>{
    const it=state.items[idx], div=document.createElement('div');
    div.className='order-item';
    if(it.collected) div.classList.add('collected');
    if(seq===state.nextCollect&&!it.collected) div.classList.add('next');
    div.textContent=ITEMS[it.itemIdx].emoji;
    const num=document.createElement('div'); num.className='order-num'; num.textContent=seq+1;
    div.appendChild(num); orderBar.appendChild(div);
  });
}

function updateHUD(){
  const secs=Math.ceil(state.timeLeft/10);
  timerText.textContent=secs+'s';
  const pct=(state.timeLeft/(state.maxTime*10))*100;
  timerBar.style.width=pct+'%';
  if(pct<25){timerBar.classList.add('danger');}else{timerBar.classList.remove('danger');timerBar.style.background=pct<50?'#ddaa00':'#22cc44';}
  scoreDisplay.textContent=state.score;
  levelDisplay.textContent='LVL '+state.level;
  highscoreDisplay.textContent='HI '+highScore;
  // NPC timer
  if(state.npc){
    const npct=(state.npc.timer/(state.npc.maxTimer))*100;
    npcTimerBar.style.width=npct+'%';
    if(npct<30) npcTimerBar.classList.add('danger'); else npcTimerBar.classList.remove('danger');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAYER MOVEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let moveThrottle = false;
function movePlayer(dx,dy){
  if(!state.running || moveThrottle) return;
  const nx=state.player.x+dx, ny=state.player.y+dy;
  if(nx<0||nx>=state.gridSize||ny<0||ny>=state.gridSize) return;
  moveThrottle = true;
  setTimeout(() => moveThrottle = false, 80);

  state.player.x=nx; state.player.y=ny;
  sfxMove();
  const key=cellKey(nx,ny);

  // Fix blackout
  if(state.blackouts.has(key)){ state.blackouts.delete(key); state.score+=10; sfxLightOn(); }

  // ‚îÄ‚îÄ Phone interaction ‚îÄ‚îÄ
  if(state.phone && nx===state.phone.x && ny===state.phone.y){
    const timeReward=50; // +5 seconds
    state.timeLeft=Math.min(state.timeLeft+timeReward, state.maxTime*10);
    state.score+=30;
    sfxPhoneAnswer(); stopPhoneRing();
    showTimeBonus(nx,ny,'+5s');
    clearPhoneTimer(); state.phone=null;
  }

  // ‚îÄ‚îÄ Email interaction ‚îÄ‚îÄ
  if(state.email && nx===state.email.x && ny===state.email.y){
    const timeReward=30; // +3 seconds
    state.timeLeft=Math.min(state.timeLeft+timeReward, state.maxTime*10);
    state.score+=20;
    sfxEmailRead();
    showTimeBonus(nx,ny,'+3s');
    clearEmailTimer(); state.email=null;
  }

  // ‚îÄ‚îÄ NPC interactions ‚îÄ‚îÄ
  if(state.npc){
    // Pick up NPC's item
    if(state.npc.phase==='waiting' && nx===state.npc.itemX && ny===state.npc.itemY){
      state.carrying=state.npc.request.emoji;
      state.npc.phase='gotItem';
      sfxCollect();
      updateSidequestBar();
    }
    // Deliver to desk
    else if(state.npc.phase==='gotItem' && state.carrying && nx===state.npc.deskX && ny===state.npc.deskY){
      state.npc.phase='delivered';
      state.carrying=null;
      sfxLightOn();
      updateSidequestBar();
    }
    // Return to NPC after desk
    else if(state.npc.phase==='delivered' && nx===state.npc.x && ny===state.npc.y){
      // Side quest complete ‚Äî TIME EXTENSION!
      const timeReward = 80; // +8 seconds
      state.timeLeft = Math.min(state.timeLeft + timeReward, state.maxTime * 10);
      state.score += 100 + state.level * 15;
      sfxNpcComplete();
      showTimeBonus(nx, ny, '+8s');
      clearNpcTimer();
      state.npc=null;
      npcTimerWrap.classList.remove('active');
      sidequestBar.classList.remove('active');
    }
  }

  // ‚îÄ‚îÄ Regular item pickup ‚îÄ‚îÄ
  const itemHere=state.items.find(it=>it.x===nx&&it.y===ny&&!it.collected);
  if(itemHere){
    const expected=state.order[state.nextCollect];
    if(state.items.indexOf(itemHere)===expected){
      itemHere.collected=true; state.score+=50+state.level*10; state.nextCollect++;
      sfxCollect();
      const remaining=state.items.filter(it=>!it.collected), empties=getEmptyCells();
      remaining.forEach((it,i)=>{if(empties[i]){it.x=empties[i].x;it.y=empties[i].y;}});
      if(state.nextCollect>=state.order.length){levelComplete();return;}
    } else {
      state.timeLeft=Math.max(0,state.timeLeft-50);
      sfxWrongDonk(); gameWrap.classList.add('shake'); showPenalty(nx,ny);
      setTimeout(()=>gameWrap.classList.remove('shake'),300);
    }
  }
  render(); renderOrder(); updateHUD();
}

function showPenalty(gx,gy){
  const popup=document.createElement('div'); popup.className='penalty-popup'; popup.textContent='-5s';
  const rect=board.getBoundingClientRect(), cs=rect.width/state.gridSize;
  popup.style.left=(rect.left+gx*cs+cs/2-15)+'px'; popup.style.top=(rect.top+gy*cs)+'px';
  document.body.appendChild(popup); setTimeout(()=>popup.remove(),1000);
}
function showTimeBonus(gx,gy,text){
  const popup=document.createElement('div'); popup.className='penalty-popup';
  popup.textContent=text; popup.style.color='#22ee44'; popup.style.fontSize='0.8rem';
  const rect=board.getBoundingClientRect(), cs=rect.width/state.gridSize;
  popup.style.left=(rect.left+gx*cs+cs/2-20)+'px'; popup.style.top=(rect.top+gy*cs)+'px';
  document.body.appendChild(popup); setTimeout(()=>popup.remove(),1200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TICKET INTERRUPTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAVE_REPLIES = [
  '"Have you turned it off and on again?"',
  '"Have you submitted a ticket?"'
];
let ticketDismissHandler=null;

function triggerTicket(){
  if(!state.running) return;
  state.running=false; // pause
  const person=TICKET_PEOPLE[Math.floor(Math.random()*TICKET_PEOPLE.length)];
  const msg=person.msgs[Math.floor(Math.random()*person.msgs.length)];
  const icon=TICKET_ICONS[Math.floor(Math.random()*TICKET_ICONS.length)];
  sfxTicket();
  document.getElementById('ticket-icon').textContent=icon;
  document.getElementById('ticket-name').textContent=person.name;
  document.getElementById('ticket-dept').textContent=`from ${person.dept}`;
  document.getElementById('ticket-msg').textContent=msg;
  document.getElementById('ticket-tap').style.display='block';
  document.getElementById('ticket-reply').style.display='none';
  const overlay=document.getElementById('ticket-overlay');
  overlay.classList.add('active');

  // Remove old handler if any
  if(ticketDismissHandler) overlay.removeEventListener('click',ticketDismissHandler);
  if(ticketDismissHandler) overlay.removeEventListener('touchstart',ticketDismissHandler);

  ticketDismissHandler=function(e){
    e.preventDefault();
    overlay.removeEventListener('click',ticketDismissHandler);
    overlay.removeEventListener('touchstart',ticketDismissHandler);
    // Show Dave's reply
    const reply=DAVE_REPLIES[Math.floor(Math.random()*DAVE_REPLIES.length)];
    const replyEl=document.getElementById('ticket-reply');
    replyEl.textContent='Dave: '+reply;
    replyEl.style.display='block';
    document.getElementById('ticket-tap').style.display='none';
    sfxLightOn();
    // Auto close after showing reply
    setTimeout(()=>{
      overlay.classList.remove('active');
      addTicketItems();
      state.running=true;
      render(); renderOrder(); updateHUD();
    }, 1400);
  };

  overlay.addEventListener('click',ticketDismissHandler);
  overlay.addEventListener('touchstart',ticketDismissHandler,{passive:false});
}

function addTicketItems(){
  const maxAdd = Math.min(2, ITEMS.length - state.items.length);
  const currentIdxs = new Set(state.items.map(it=>it.itemIdx));
  const available = [...Array(ITEMS.length).keys()].filter(i=>!currentIdxs.has(i));
  const toAdd = shuffle(available).slice(0, Math.max(1, maxAdd));

  toAdd.forEach(idx=>{
    const empties=getEmptyCells();
    if(empties.length>0){
      state.items.push({x:empties[0].x, y:empties[0].y, itemIdx:idx, collected:false});
      state.order.push(state.items.length-1);
    }
  });
  // Also reshuffle positions of uncollected items
  const remaining=state.items.filter(it=>!it.collected);
  const empties=getEmptyCells();
  remaining.forEach((it,i)=>{if(empties[i]){it.x=empties[i].x;it.y=empties[i].y;}});
}

function startTicketTimer(){
  if(state.ticketInterval) clearInterval(state.ticketInterval);
  state.ticketInterval=setInterval(()=>{
    if(!state.running) return;
    if(state.level>=2 && Math.random()<0.008){ // ~every 12s on average
      triggerTicket();
    }
  },1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDE QUEST NPCs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnNpc(){
  if(state.npc || !state.running || state.level < 3) return;
  const req=NPC_REQUESTS[Math.floor(Math.random()*NPC_REQUESTS.length)];
  const gs=state.gridSize;
  // NPC in a corner
  const corners=[{x:0,y:0},{x:gs-1,y:0},{x:0,y:gs-1},{x:gs-1,y:gs-1}];
  const corner=corners[Math.floor(Math.random()*corners.length)];
  // Find empty cells for item and desk
  const empties=getEmptyCells().filter(c=>!(c.x===corner.x&&c.y===corner.y));
  if(empties.length<2) return;
  const itemPos=empties[0], deskPos=empties[1];

  state.npc={
    x:corner.x, y:corner.y, request:req,
    deskX:deskPos.x, deskY:deskPos.y,
    itemX:itemPos.x, itemY:itemPos.y,
    timer:200, maxTimer:200, // 20 seconds
    phase:'waiting'
  };
  sfxNpcArrive();
  npcTimerWrap.classList.add('active');
  npcTimerLabel.textContent=`${req.person}: "${req.name}"`;
  updateSidequestBar();

  // Start NPC countdown
  if(state.npcTimerInterval) clearInterval(state.npcTimerInterval);
  state.npcTimerInterval=setInterval(()=>{
    if(!state.running||!state.npc) return;
    state.npc.timer--;
    updateHUD();
    if(state.npc.timer<=0){
      // NPC gives up
      sfxNpcFail();
      state.timeLeft=Math.max(0,state.timeLeft-50); // -5 sec penalty
      clearNpcTimer();
      state.npc=null; state.carrying=null;
      npcTimerWrap.classList.remove('active');
      sidequestBar.classList.remove('active');
      render(); updateHUD();
    }
  },100);
}

function clearNpcTimer(){
  if(state.npcTimerInterval){clearInterval(state.npcTimerInterval);state.npcTimerInterval=null;}
}

function updateSidequestBar(){
  if(!state.npc){sidequestBar.classList.remove('active');return;}
  sidequestBar.classList.add('active');
  const r=state.npc.request;
  if(state.npc.phase==='waiting') sidequestBar.innerHTML=`‚ù∂ Pick up ${r.emoji} ${r.name} ‚Üí +8s`;
  else if(state.npc.phase==='gotItem') sidequestBar.innerHTML=`‚ù∑ Bring ${r.emoji} to üóÑÔ∏è desk ‚Üí +8s`;
  else if(state.npc.phase==='delivered') sidequestBar.innerHTML=`‚ù∏ Return to ${r.personEmoji} ‚Üí +8s!`;
}

let npcSpawnInterval=null;
function startNpcSpawner(){
  if(npcSpawnInterval) clearInterval(npcSpawnInterval);
  npcSpawnInterval=setInterval(()=>{
    if(!state.running||state.npc) return;
    // Spawn chance increases with level: 1.5% at lvl3, up to ~4% at high levels
    const npcChance = Math.min(0.015 + (state.level - 3) * 0.004, 0.045);
    if(state.level>=3 && Math.random()<npcChance) spawnNpc();
  },1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PHONE CALLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnPhone(){
  if(state.phone||!state.running) return;
  const empties=getEmptyCells();
  if(empties.length===0) return;
  const pos=empties[0];
  state.phone={x:pos.x, y:pos.y, timer:80, maxTimer:80}; // 8 seconds to answer
  sfxPhoneRing();
  render();
  // Phone countdown
  if(state.phoneTimerInterval) clearInterval(state.phoneTimerInterval);
  state.phoneTimerInterval=setInterval(()=>{
    if(!state.running||!state.phone) return;
    state.phone.timer--;
    if(state.phone.timer<=0){
      // Missed the call
      sfxPhoneMissed(); stopPhoneRing();
      state.timeLeft=Math.max(0,state.timeLeft-30); // -3s penalty
      showPenalty(state.phone.x, state.phone.y);
      clearPhoneTimer(); state.phone=null;
      render();
    }
  },100);
}
function clearPhoneTimer(){if(state.phoneTimerInterval){clearInterval(state.phoneTimerInterval);state.phoneTimerInterval=null;}}

let phoneSpawnInterval=null;
function startPhoneSpawner(){
  if(phoneSpawnInterval) clearInterval(phoneSpawnInterval);
  phoneSpawnInterval=setInterval(()=>{
    if(!state.running||state.phone) return;
    if(state.level>=2 && Math.random()<0.012) spawnPhone();
  },1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EMAIL NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnEmail(){
  if(state.email||!state.running) return;
  const empties=getEmptyCells();
  if(empties.length===0) return;
  const pos=empties[0];
  state.email={x:pos.x, y:pos.y, timer:100, maxTimer:100}; // 10 seconds to read
  sfxEmailArrive();
  render();
  if(state.emailTimerInterval) clearInterval(state.emailTimerInterval);
  state.emailTimerInterval=setInterval(()=>{
    if(!state.running||!state.email) return;
    state.email.timer--;
    if(state.email.timer<=0){
      sfxEmailMissed();
      state.timeLeft=Math.max(0,state.timeLeft-20); // -2s penalty
      showPenalty(state.email.x, state.email.y);
      clearEmailTimer(); state.email=null;
      render();
    }
  },100);
}
function clearEmailTimer(){if(state.emailTimerInterval){clearInterval(state.emailTimerInterval);state.emailTimerInterval=null;}}

let emailSpawnInterval=null;
function startEmailSpawner(){
  if(emailSpawnInterval) clearInterval(emailSpawnInterval);
  emailSpawnInterval=setInterval(()=>{
    if(!state.running||state.email) return;
    if(state.level>=1 && Math.random()<0.01) spawnEmail();
  },1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BLACKOUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnBlackout(){
  if(!state.running) return;
  if(state.blackouts.size>=Math.floor(state.gridSize*state.gridSize*0.3)) return;
  const empties=getEmptyCells().filter(c=>!state.blackouts.has(cellKey(c.x,c.y)));
  if(empties.length===0) return;
  const pick=empties[Math.floor(Math.random()*empties.length)];
  state.blackouts.add(cellKey(pick.x,pick.y));
  sfxBlackout(); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTimer(){
  if(state.timerInterval) clearInterval(state.timerInterval);
  state.timerInterval=setInterval(()=>{
    if(!state.running) return;
    state.timeLeft--; updateHUD();
    if(state.timeLeft<=0) gameOver();
  },100);
}
function startBlackouts(){
  if(state.blackoutInterval) clearInterval(state.blackoutInterval);
  const iv=Math.max(2000,5000-state.level*400);
  state.blackoutInterval=setInterval(()=>{if(state.running) spawnBlackout();},iv);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(){
  initAudio();
  state.level=1; state.score=0;
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('gameover-screen').classList.add('hidden');
  document.getElementById('level-screen').classList.add('hidden');
  document.getElementById('promo-screen').classList.add('hidden');
  state.running=true;
  initLevel(); startTimer(); startBlackouts(); startMusic(); startCountdownTick(); startTicketTimer(); startNpcSpawner(); startPhoneSpawner(); startEmailSpawner();
}

function levelComplete(){
  state.running=false;
  clearInterval(state.timerInterval); clearInterval(state.blackoutInterval); clearInterval(state.ticketInterval);
  clearNpcTimer(); clearPhoneTimer(); clearEmailTimer(); stopPhoneRing();
  if(npcSpawnInterval)clearInterval(npcSpawnInterval);
  if(phoneSpawnInterval)clearInterval(phoneSpawnInterval);
  if(emailSpawnInterval)clearInterval(emailSpawnInterval);
  stopMusic(); stopCountdownTick();
  sfxLevelComplete();
  const timeBonus=Math.floor(state.timeLeft/10)*5;
  state.score+=timeBonus;
  if(state.score>highScore) highScore=state.score;
  gameWrap.classList.add('server-saved');
  setTimeout(()=>gameWrap.classList.remove('server-saved'),1800);
  document.getElementById('level-msg').innerHTML=`Server ${state.level} is back online!<br>Time bonus: +${timeBonus}`;
  document.getElementById('level-score').textContent='SCORE: '+state.score;
  document.getElementById('level-screen').classList.remove('hidden');
  updateHUD();
}

function nextLevel(){
  document.getElementById('level-screen').classList.add('hidden');
  state.level++;
  const promo=checkPromotion();
  if(promo){showPromotion(promo);return;}
  continueToLevel();
}
function showPromotion(promo){
  sfxPromotion();
  document.getElementById('promo-new-title').textContent=promo.title;
  document.getElementById('promo-new-title').style.color=promo.color;
  document.getElementById('promo-desc').textContent=promo.desc;
  document.getElementById('promo-screen').classList.remove('hidden');
}
function continueToLevel(){
  state.running=true;
  initLevel(); startTimer(); startBlackouts(); startMusic(); startCountdownTick(); startTicketTimer(); startNpcSpawner(); startPhoneSpawner(); startEmailSpawner();
}
function gameOver(){
  state.running=false;
  clearInterval(state.timerInterval); clearInterval(state.blackoutInterval); clearInterval(state.ticketInterval);
  clearNpcTimer(); clearPhoneTimer(); clearEmailTimer(); stopPhoneRing();
  if(npcSpawnInterval)clearInterval(npcSpawnInterval);
  if(phoneSpawnInterval)clearInterval(phoneSpawnInterval);
  if(emailSpawnInterval)clearInterval(emailSpawnInterval);
  stopMusic(); stopCountdownTick();
  sfxGameOver();
  const isNew=state.score>highScore; if(isNew) highScore=state.score;
  document.getElementById('final-score').textContent='SCORE: '+state.score;
  document.getElementById('final-level').textContent='REACHED LEVEL '+state.level;
  const hs=document.getElementById('new-hs');
  if(isNew&&state.score>0) hs.classList.remove('hidden'); else hs.classList.add('hidden');
  document.getElementById('gameover-screen').classList.remove('hidden');
  gameWrap.classList.add('shake'); setTimeout(()=>gameWrap.classList.remove('shake'),300);
  updateHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYBOARD CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown',e=>{
  switch(e.key){
    case'ArrowUp':e.preventDefault();movePlayer(0,-1);break;
    case'ArrowDown':e.preventDefault();movePlayer(0,1);break;
    case'ArrowLeft':e.preventDefault();movePlayer(-1,0);break;
    case'ArrowRight':e.preventDefault();movePlayer(1,0);break;
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPLIT D-PAD CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const dirMap={up:{dx:0,dy:-1},down:{dx:0,dy:1},left:{dx:-1,dy:0},right:{dx:1,dy:0}};
const dpadBtns=document.querySelectorAll('.dpad-btn');
let dpadIntervals={};

function dpadStart(dir,btn){
  btn.classList.add('pressed');
  const d=dirMap[dir];
  movePlayer(d.dx,d.dy); // immediate first move
  // Auto-repeat on hold
  if(dpadIntervals[dir]) clearInterval(dpadIntervals[dir]);
  dpadIntervals[dir]=setInterval(()=>movePlayer(d.dx,d.dy),130);
}
function dpadStop(dir,btn){
  btn.classList.remove('pressed');
  if(dpadIntervals[dir]){clearInterval(dpadIntervals[dir]);delete dpadIntervals[dir];}
}

dpadBtns.forEach(btn=>{
  const dir=btn.dataset.dir;
  // Touch events
  btn.addEventListener('touchstart',e=>{
    e.preventDefault(); e.stopPropagation();
    dpadStart(dir,btn);
  },{passive:false});
  btn.addEventListener('touchend',e=>{
    e.preventDefault();
    dpadStop(dir,btn);
  },{passive:false});
  btn.addEventListener('touchcancel',e=>{
    dpadStop(dir,btn);
  });
  // Mouse fallback (for testing on desktop)
  btn.addEventListener('mousedown',e=>{
    e.preventDefault();
    dpadStart(dir,btn);
  });
  btn.addEventListener('mouseup',e=>{
    dpadStop(dir,btn);
  });
  btn.addEventListener('mouseleave',e=>{
    dpadStop(dir,btn);
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUTTONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('start-btn').addEventListener('click',startGame);
document.getElementById('restart-btn').addEventListener('click',startGame);
document.getElementById('next-btn').addEventListener('click',nextLevel);
document.getElementById('promo-btn').addEventListener('click',()=>{document.getElementById('promo-screen').classList.add('hidden');continueToLevel();});
document.getElementById('sound-toggle').addEventListener('click',()=>{
  soundEnabled=!soundEnabled;
  document.getElementById('sound-toggle').textContent=soundEnabled?'üîä':'üîá';
  if(!soundEnabled){stopMusic();stopCountdownTick();}else if(state.running){startMusic();startCountdownTick();}
});
</script>
</body>
</html>
